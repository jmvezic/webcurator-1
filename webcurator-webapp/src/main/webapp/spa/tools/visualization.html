<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Target Instance</title>
  <link rel="stylesheet" href="../dist/font/fontawesome-free.min.css">
  <link rel="stylesheet" href="../dist/adminlte/css/adminlte.min.css">
  <!-- <link rel="stylesheet" href="../dist/bootstrap/4.4.1/css/bootstrap.css"> -->
  <link rel="stylesheet" href="../dist/fancytree/skin-win8/ui.fancytree.min.css">
  <link rel="stylesheet" href="../dist/jquery/menu/jquery.contextMenu.css">
  <link rel="stylesheet" href="../dist/ag-grid/ag-grid.css">
  <link rel="stylesheet" href="../dist/ag-grid/ag-theme-balham.css">
  <link rel="stylesheet" href="../dist/ag-grid/ag-theme-balham-dark.css">
  <link rel="stylesheet" href="visualization.css">
</head>
<!--
BODY TAG OPTIONS:
=================
Apply one or more of the following classes to to the body tag
to get the desired effect
|---------------------------------------------------------|
|LAYOUT OPTIONS | sidebar-collapse                        |
|               | sidebar-mini                            |
|---------------------------------------------------------|
-->
<body unselectable="on" class="layout-navbar-fixed sidebar-collapse">
<nav class="main-header navbar navbar-expand navbar-dark" style="padding: 0; margin: 0;">
  <!-- Left navbar links -->
  <ul class="navbar-nav">
    <div class="btn-group btn-group-toggle" id="btn-group-main-tabs" data-toggle="buttons" style="height: 35px; margin: 5px;">
      <label class="btn btn-secondary active" name="networkmap">
        <input type="radio" name="options" autocomplete="off" checked> <i class="fas fa-vector-square"></i>
      </label>
      <label class="btn btn-secondary" name="tree-harvest-struct">
        <input type="radio" name="options" autocomplete="off"> <i class="fas fa-bezier-curve"></i>
      </label>
      <label class="btn btn-secondary" name="tree-url-names">
        <input type="radio" name="options" autocomplete="off"> <i class="fa fa-folder-open"></i>
      </label>
      <label class="btn btn-secondary" name="candidate-query">
        <input type="radio" name="options" autocomplete="off"> <i class="fas fa-binoculars"></i>
      </label>
    </div>
    
    <div class="btn-group">
        <button type="button" class="btn btn-secondary dropdown-toggle dropdown-icon" data-toggle="dropdown" style="height: 35px; margin: 5px;">
          Action
          <span class="sr-only">Toggle Dropdown</span>
          <div class="dropdown-menu" role="menu">
            <a class="dropdown-item inspect-only-menu-item hidden" href="#" onclick="$('#popup-window-query-input').show();"><i class="fas fa-search"></i> &nbsp; Inspect By Query</a>
            <div class="dropdown-divider inspect-only-menu-item hidden"></div>
            <a class="dropdown-item" href="#" onclick="gPopupModifyHarvest.showBulkPrune();"><i class="far fa-times-circle text-secondary"></i> &nbsp; Bulk Prune</a>
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="#" onclick="gPopupModifyHarvest.showImport();"><i class="fas fa-file-import text-primary"></i> &nbsp; Single Import</a>
            <a class="dropdown-item" href="#" onclick="gPopupModifyHarvest.showBulkImport();"><i class="fas fa-file-import text-warning"></i> &nbsp; Bulk Import</a>
            <div class="dropdown-divider inspect-only-menu-item hidden"></div>
            <a class="dropdown-item inspect-only-menu-item hidden" href="#" onclick="gPopupModifyHarvest.gridCandidate.clearAll();"><i class="far fa-trash-alt"></i> &nbsp; Clear</a>
          </div>
        </button>
    </div>

     <input class="form-control inspect-only-search-item" type="search" placeholder="Filter" aria-label="Search" for="candidateGrid" disabled="disabled" style="height: 35px; margin: 5px;">
  </ul>


  <!-- Right navbar links -->
  <ul class="navbar-nav ml-auto">
    <!-- Derived Harvest Results -->
    <li class="nav-item dropdown">
      <a class="nav-link" data-toggle="dropdown" href="#" onclick="updateDerivedHarvestResults();">
        <i class="fas fa-project-diagram">&nbsp;Derived</i>
        <!-- Derived -->
        <span class="badge badge-warning navbar-badge hidden" id="derived-hr-badge">0</span>
      </a>
      <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right" id="derived-hr-list">
        <span class="dropdown-item dropdown-header">Derived Harvest Results</span>
        <div class="dropdown-divider"></div>
        <a href="#" class="dropdown-item">
          <i class="fas fa-external-link-square-alt"></i> 1
          <span class="float-right text-muted text-sm">Summary</span>
        </a>
      </div>
    </li>

    <!-- To be modified: Cart -->
    <li class="nav-item d-none d-sm-inline-block">
      <a onclick="$('#popup-window-modify-harvest').show();" class="nav-link bg-success"><i class="fas fa-shopping-cart">&nbsp; To Be Modified</i></a>
    </li>

    <li class="nav-item">
      <a onclick="toggleScreenSize();" role="button" class="nav-link btn-full-screen"><i class="fas fa-expand"></i></a>
    </li>
    <li class="nav-item">
      <a onclick="gParentHarvestResultViewTab.closeContentWindow();" role="button" class="nav-link"><i class="fas fa-times"></i></a>
    </li>
  </ul>
</nav> <!-- End of Header -->

<div id="main-tab-group">
  <!-- Network Map -->
  <div class="card main-tab" id="networkmap">
    <div class="card-body" style="height: calc(100vh - 50px); width: 100vw;">
      <!-- Networmap Canvas -->
      <div id="network-map-canvas" style="position: absolute; height: calc(100% + 2px); width: calc(100% + 2px); margin-left: -1px; margin-top: -1px;"></div>

      <div class="card" style="position: absolute; left: 1px; top: 5px; width: 400px; margin: 0; padding: 0;">
        <div class="card-header" style="height: 35px; padding-top: 3px;">
          <h3 class="card-title">Catagory</h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool btn-side-group-type text-primary" name="statuscode">Status</button>
            <button type="button" class="btn btn-tool btn-side-group-type" name="contenttype">Type</button>
            <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
          </div>
        </div>
        <div class="card-body" style="margin: 0; padding: 0; height: calc(100vh - 85px);">
           <!-- Side Card -->
          <div id="networkmap-side-container" style="height: 100%; width: 100%;">
            <div class="networkmap-insight ag-theme-balham" id="networkmap-side-table-group-by-status-code"> </div>
            <div class="networkmap-insight ag-theme-balham hidden" id="networkmap-side-table-group-by-content-type"> </div>
          </div> <!-- end of side card -->
        </div> <!-- end of card body -->        
      </div> <!-- end of card -->

      <!-- Domain Name -->
      <div style="position: absolute; left: 450px; top: 5px; margin: 0; padding: 0;">
        <h3 class="text-info">Current Domain: <span class="text-success" id="networkmap-side-title">Root</span></h3>
      </div>

      <!-- Redraw and Collapse -->
      <div style="position: absolute; right: 5px; top: 5px; margin: 0; padding: 0;">
        <div class="btn-group">
          <!-- <button type="button" class="btn btn-default" onclick="networkmap.reload();">Reload</button> -->
          <button type="button" class="btn btn-default" onclick="networkmap.graph.redraw();">Redraw</button>
          <button type="button" class="btn btn-default" onclick="networkmap.graph.collapseAll();">Collapse</button>
        </div>
      </div>
    </div>    <!-- End of card body -->
    <div class="overlay dark"><div class="spin-overlay text-white"><i class="fas fa-circle-notch text-default"></i></div></div>
  </div>


  <!-- TreeView: Harvest Struct -->
  <div class="card main-tab hidden" id="tree-harvest-struct">
    <div class="card-body" style="width: 100%; height:100%; overflow-x: hidden; overflow-y: scroll;">
      <table id="hierachy-tree-harvest-struct" style="width: 100%; outline: none;">
        <colgroup><col width="50px"><col width="*"><col width="80px"><col width="80px"><col width="80px"><col width="80px"><col width="80px"><col width="80px"><col width="80px"></colgroup>
        <thead><tr><th>Action</th><th>URL</th><th>Type</th><th>Status</th><th>Size</th><th>URLs</th><th>Success</th><th>Failed</th><th>TotSize</th></tr></thead>
      </table>
    </div>
    <div class="overlay dark"><div class="spin-overlay text-white"><i class="fas fa-circle-notch text-default"></i></div></div>
  </div>


  <!-- TreeView: URL Names -->
  <div class="card main-tab hidden" id="tree-url-names">
    <div class="card-body" style="width: 100%; height:100%; overflow-x: hidden; overflow-y: scroll;">
        <table id="hierachy-tree-url-names" style="width: 100%; outline: none;">
          <colgroup><col width="50px"><col width="*"><col width="80px"><col width="80px"><col width="80px"><col width="80px"><col width="80px"><col width="80px"><col width="80px"></colgroup>
          <thead><tr><th>Action</th><th>URL</th><th>Type</th><th>Status</th><th>Size</th><th>URLs</th><th>Success</th><th>Failed</th><th>TotSize</th></tr></thead>
      </table>
    </div>
    <div class="overlay dark"><div class="spin-overlay text-white"><i class="fas fa-circle-notch text-default"></i></div></div>
  </div>

  <!-- Query Grid -->
  <div class="card main-tab hidden" id="candidate-query">
    <div class="card-body" style="width: 100%; height:100%; overflow: hidden;">
      <div id="grid-modify-candidate" class="ag-theme-balham grid-modify-harvest"> </div>
    </div>
    <div class="overlay dark"><div class="spin-overlay text-white"><i class="fas fa-circle-notch text-default"></i></div></div>
  </div>
</div>

<!-- Popup window for inspection and modification -->
<div class="popup-window" id="popup-window-modify-harvest">
<div class="card none-margin-padding" style="width: 60%; margin: 5% 20% 5% 20%; border: solid; border-width: 5px; border-color: #28a745;">
  <div class="card-header bg-success" style="border-radius: 0px;">
    <h3 class="card-title">To Be Pruned and Imported:</h3>

    <div class="card-tools">
      <button type="button" class="btn btn-tool" onclick="$('#popup-window-modify-harvest').hide();"><i class="fas fa-times"></i></button>
    </div>
    <!-- /.card-tools -->
  </div>
  <!-- /.card-header -->
  <div class="card-body none-margin-padding">
      <div class="row">
        <div class="col-5">
          <h5>To Be Pruned:</h5>
        </div>
        <div class="col-7">
          <h5>To Be Imported</h5>
        </div>
      </div>
      <div class="row" style="height: 40vh;">
        <div class="col-5">
          <div id="grid-modify-prune" class="ag-theme-balham grid-modify-harvest"> </div>
        </div>
        <div class="col-7">
          <div id="grid-modify-import" class="ag-theme-balham grid-modify-harvest"> </div>
        </div>
      </div>


      <div class="input-group" style="margin: 5px 2px 0 2px; width: calc(100% - 4px);">
        <textarea id="provenance-note" class="form-control" rows="3"  placeholder="Provenance Note ..."></textarea>
      </div>
  </div>  <!-- End of card body -->

  <div class="card-footer">
    <div class="row">
      <div class="col-8"></div>
      <div class="col-2">
          <button type="button" class="btn btn-block btn-success" onclick="gPopupModifyHarvest.apply();">Apply</button>
      </div>
      <div class="col-2">
          <button type="button" class="btn btn-block btn-secondary" onclick="$('#popup-window-modify-harvest').hide();">Close</button>
      </div>
    </div>
  </div>
</div> 
</div>

<!-- Popup Hop Path-->
<div class="popup-window" id="popup-window-hop-path">
<div class="card card-primary popup-content">
  <div class="card-header">
    <h3 class="card-title">Hop Path</h3>

    <div class="card-tools">
      <button type="button" class="btn btn-tool" onclick="$('#popup-window-hop-path').hide();"><i class="fas fa-times"></i>
      </button>
    </div>
    <!-- /.card-tools -->
  </div>
  <!-- /.card-header -->
  <div class="card-body none-margin-padding"  id="hoppath-canvas" style="background: white; height: calc(100% - 50px);">
  </div>   <!-- /.card-body -->
</div> <!-- /.card -->
</div>

<!-- Popup Single Import Input-->
<div class="popup-window" id="popup-window-single-import">
<div class="card card-primary popup-content">
  <div class="card-header">
    <h3 class="card-title">Single Import (<span id="single-impot-mode">New</span>)</h3>
    <div class="card-tools">
      <button type="button" class="btn btn-tool" onclick="$('#popup-window-single-import').hide();"><i class="fas fa-times"></i></button>
    </div>
    <!-- /.card-tools -->
  </div>
  <!-- /.card-header -->
  <div class="card-body" style="margin: 5px; padding: 5px 5px 0 5px; background-color: white;">
        <div class="form-group">
          <label for="specifyTargetUrlInput">Specify Target URL</label>
          <input type="input" class="form-control" id="specifyTargetUrlInput" placeholder="Specify Target URL">
        </div>
  </div>

  <div class="card-body" style="margin: 5px; padding: 5px 5px 0 5px; background-color: white;" id="card-body-source">
        <div class="form-group">
          <!-- <label for="importFromFileInput">Import from disk file</label> -->
          <div class="custom-control custom-radio">
            <input class="custom-control-input" type="radio" id="customRadio1" name="customRadio" flag="File" checked>
            <label for="customRadio1" class="custom-control-label">Option 1: Re-crawl from disk file</label>
          </div>
          <div class="input-group">
            <div class="custom-file">
              <input type="file" class="custom-file-input" id="sourceFile" name="sourceFile">
              <label class="custom-file-label" for="sourceFile" id="label-source-file">Choose file</label>
            </div>
            <div class="input-group-append">
              <!-- <span class="input-group-text" id="">Upload</span> -->
              <!-- <input type="submit" value="import" id="submit"/> -->
            </div>
          </div>
          <br/>
          
          <div class="form-group clearfix" id="radio-group-modified-date">
            <label for="radio-group-modified-date">Modified Datetime</label>
            <div class="custom-control custom-radio d-inline">
              <input type="radio" id="radioModifiedDateModeTbc" name="r1" flag="TBC" checked>
              <label for="radioModifiedDateModeTbc" style="font-weight: normal;">TBC</label>
            </div>
            <div class="custom-control custom-radio d-inline">
              <input type="radio" id="radioModifiedDateModeFile" name="r1" flag="File">
              <label for="radioModifiedDateModeFile" style="font-weight: normal;">File Modified Time</label>
            </div>
            <div class="custom-control custom-radio d-inline">
              <input type="radio" id="radioModifiedDateModeCustom" name="r1" flag="CUSTOM">
              <label for="radioModifiedDateModeCustom" style="font-weight: normal;">Custom</label>
              <input type="datetime-local" id="datetime-local-customizard">
            </div>
            <!-- <div class="custom-control d-inline"  style="width: 12vw;">
              <input type="datetime-local" id="datetime-local-customizard">
            </div>   -->          
          </div>
        </div>
  </div>
  
  <div class="card-body" style="margin: 5px; padding: 5px 5px 0 5px; background-color: white;" id="card-body-modified-date">
        <div class="custom-control custom-radio">
          <input class="custom-control-input" type="radio" id="customRadio2" name="customRadio" flag="URL">
          <label for="customRadio2" class="custom-control-label">Option 2: Re-crawl from URL</label>
        </div>
        <div class="custom-control">
          <label class="text-secondary">Source URL: the same as Target URL</label>
          <!-- <input type="input" class="form-control" id="importFromUrlInput" placeholder="Source URL">
          <div class="input-group-append">
            <span class="input-group-text" onclick="useTargetURL();">Use Target URL</span>
          </div> -->
        </div>
        <br/>
  </div>  <!-- /.card-body -->

  <div class="card-footer">
    <div class="row">
      <div class="col-8">
        <div class="custom-control custom-checkbox">
          <input class="custom-control-input" type="checkbox" id="checkbox-prune-of-single-import" checked>
          <label for="checkbox-prune-of-single-import" class="custom-control-label">Prune the existing content when exist</label>
        </div>
      </div>
      <div class="col-2">
          <!-- <button type="button" class="btn btn-block btn-primary" onclick="spPrunedImported($('#tab-btn-import'));">Import</button> -->
          <button type="button" class="btn btn-block btn-primary" onclick="gPopupModifyHarvest.processorModify.singleImport();">Re-crawl</button>
          <!-- <input type="submit" value="Re-crawl" class="btn btn-block btn-primary" id="submit"/> -->
      </div>
      <div class="col-2">
          <button type="button" class="btn btn-block btn-secondary" onclick="$('#popup-window-single-import').hide();">Close</button>
      </div>
    </div>
  </div>
</div> <!-- /.card -->
</div>


<!-- Popup Bulk Import-->
<div class="popup-window" id="popup-window-bulk-import">
<div class="card card-primary popup-content">
  <div class="card-header">
    <h3 class="card-title">Bulk Import</h3>
    <div class="card-tools"><button type="button" class="btn btn-tool" onclick="$('#popup-window-bulk-import').hide();"><i class="fas fa-times"></i></button></div>
    <!-- /.card-tools -->
  </div>  <!-- /.card-header -->
  <div class="card-body">
    <div class="tab-bulk-import" id="tab-bulk-import-0">
      <p> You could download a <a href="/spa/tools/bulk-import-template.csv">Template</a> from here.</p>
      <div class="form-group">
        <label for="specifyTargetUrlInput">Please upload a METADATA file:</label>
        <div class="custom-file">
          <input type="file" class="custom-file-input" id="bulkImportMetadataFile">
          <label class="custom-file-label" for="bulkImportMetadataFile" id="label-bulk-import-metadata-file">Choose file</label>
        </div>
      </div>
      <div class="form-group">
        <label>Column separator:</label>
        <select class="custom-select" id="bulk-import-column-separator">
          <option>Tab</option>
          <option>,</option>
          <option>|</option>
        </select>
      </div>
    </div>


    <div class="tab-bulk-import hidden" id="tab-bulk-import-1">
      <div id="grid-bulk-import-prepare" class="ag-theme-balham grid-modify-harvest" style="width: 100%; height: 30vh;"> </div>
      <br/>
      <p id="tip-bulk-import-prepare">All rows are valid.</p>
      <p id="tip-bulk-import-prepare-invalid" class="hidden">Please upload relevant files <a href="javascript:$('#bulkImportContentFile').trigger('click');">Choose content files</a></p>


      <input type="file" class="hidden" id="bulkImportContentFile" onchange="gPopupModifyHarvest.processorModify.bulkUploadFiles();" multiple>
    </div>

  </div>  <!-- /.card-body -->

  <div class="card-footer">
    <div class="row">
      <div class="col-8">
        <div class="custom-control custom-checkbox">
          <input class="custom-control-input" type="checkbox" id="checkbox-prune-of-bulk-import" checked>
          <label for="checkbox-prune-of-bulk-import" class="custom-control-label">Prune the existing content when exist</label>
        </div>
      </div>
      <div class="col-2">
          <button type="button" class="btn btn-block btn-primary" id="btn-bulk-import-submit" step="0">Next</button>
      </div>
      <div class="col-2">
          <button type="button" class="btn btn-block btn-secondary" onclick="$('#popup-window-bulk-import').hide();">Close</button>
      </div>
    </div>
  </div>

</div> <!-- /.card -->
</div>


<!-- Popup Bulk Prune-->
<div class="popup-window" id="popup-window-bulk-prune">
<div class="card card-primary popup-content">
  <div class="card-header">
    <h3 class="card-title">Bulk Prune</h3>
    <div class="card-tools"><button type="button" class="btn btn-tool" onclick="$('#popup-window-bulk-prune').hide();"><i class="fas fa-times"></i></button></div>
    <!-- /.card-tools -->
  </div>  <!-- /.card-header -->
  <div class="card-body">
      <p> You could download a <a href="/spa/tools/bulk-prune-template.csv">Template</a> from here.</p>
      <div class="form-group">
        <label for="specifyTargetUrlInput">Please upload a METADATA file:</label>
        <div class="custom-file">
          <input type="file" class="custom-file-input" id="bulkPruneMetadataFile">
          <label class="custom-file-label" for="bulkPruneMetadataFile" id="label-bulk-prune-metadata-file">Choose file</label>
        </div>
      </div>
      <div class="form-group">
        <div class="custom-control custom-checkbox">
          <input class="custom-control-input" type="checkbox" id="checkbox-ignore-invalid-prune-urls">
          <label for="checkbox-ignore-invalid-prune-urls" class="custom-control-label">Ignore invalid URLs to be pruned</label>
        </div>
      </div>
      <div class="form-group">
        <div class="custom-control custom-checkbox">
          <input class="custom-control-input" type="checkbox" id="checkbox-ignore-duplicated-prune-urls" checked>
          <label for="checkbox-ignore-duplicated-prune-urls" class="custom-control-label">Ignore duplicated URLs to be pruned</label>
        </div>
      </div>
  </div>  <!-- /.card-body -->

  <div class="card-footer">
    <div class="row">
      <div class="col-8"></div>
      <div class="col-2">
          <button type="button" class="btn btn-block btn-primary" onclick="gPopupModifyHarvest.processorModify.bulkPrune();">Prune</button>
      </div>
      <div class="col-2">
          <button type="button" class="btn btn-block btn-secondary" onclick="$('#popup-window-bulk-prune').hide();">Close</button>
      </div>
    </div>
  </div>

</div> <!-- /.card -->
</div>


<!-- Popup Query Input-->
<div class="popup-window" id="popup-window-query-input">
<div class="card card-primary popup-content">
  <div class="card-header">
    <h3 class="card-title">Query URLs</h3>
    <div class="card-tools">
      <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
    </div>
    <!-- /.card-tools -->
  </div>
  <!-- /.card-header -->
  <div class="card-body">
    <div class="form-group">
      <label for="queryDomainName">Domain Name:</label>
      <input type="input" class="form-control" id="queryDomainName" placeholder="Key words of Domain Name, multiple key words divided by ','">
    </div>

    <div class="form-group">
      <label for="queryUrlName">URL Name:</label>
      <input type="input" class="form-control" id="queryUrlName" placeholder="Key words of URL Name, multiple key words divided by ','">
    </div>

    <div class="form-group">
      <label for="queryStatusCode">Status Code:</label>
      <input type="input" class="form-control" id="queryStatusCode" placeholder="Key words of Status Code, multiple key words divided by ','">
    </div>

    <div class="form-group">
      <label for="queryContentType">Content Type:</label>
      <input type="input" class="form-control" id="queryContentType" placeholder="Key words of Content Type, multiple key words divided by ','">
    </div>
  </div>  <!-- /.card-body -->

  <div class="card-footer">
    <div class="row">
      <div class="col-8">
      </div>
      <div class="col-2">
          <button type="button" class="btn btn-block btn-primary" onclick="gPopupModifyHarvest.queryHarvest();">Query</button>
          </div>
      <div class="col-2">
          <button type="button" class="btn btn-block btn-secondary" onclick="$('#popup-window-query-input').hide();">Close</button>
      </div>
    </div>
  </div>
  <!-- <div class="card-footer" style="width: 100%; position: absolute; bottom: 0;">
  </div> -->

</div> <!-- /.card -->
</div>


<div class="popup-window" id="popup-window-derived-summary">
<div class="card card-primary popup-content">
  <div class="card-header">
    <h3 class="card-title">Summary</h3>

    <div class="card-tools">
      <button type="button" class="btn btn-tool btn-full-screen" onclick="toggleScreenSize();"><i class="fas fa-expand"></i>
      </button>

      <button type="button" class="btn btn-tool" onclick="$('#popup-window-derived-summary').hide();"><i class="fas fa-times"></i>
      </button>

    </div>
    <!-- /.card-tools -->
  </div>
  <!-- /.card-header -->
  <div class="card-body none-margin-padding" id="body-derived-summary" style="background: white; height: calc(100vh - 55px); width: 100vw; overflow-y: auto; overflow-x: hidden;">
  </div>   <!-- /.card-body -->
</div> <!-- /.card -->
</div>

<div id="popup-window-loading" class="hidden">
  <div class="spin-overlay text-secondary"><i class="fas fa-circle-notch text-default"></i></div>
  <div id="progressIndexer" class="text-secondary hidden" style="width: 100%; text-align: center; font-size: 1.5em;">Indexing: <span class="text-dark" id="progressIndexerValue">0</span>%</div>
</div>

<script src="../dist/jquery/jquery-3.4.1.min.js"></script>
<script src="../dist/bootstrap/bootstrap.bundle.min.js"></script>
<script src="../dist/plugins/bs-custom-file-input.min.js"></script>
<script src="../dist/adminlte/js/adminlte.js"></script>
<script src="../dist/vis/vis-network.js"></script>
<script src="../dist/fancytree/jquery.fancytree-all-deps.min.js"></script>
<script src="../dist/fancytree/modules/jquery.fancytree.table.js"></script>
<script src="../dist/fancytree/modules/jquery.fancytree.wide.js"></script>
<script src="../dist/fancytree/modules/jquery.fancytree.logger.js"></script>
<script src="../dist/jquery/menu/jquery.contextMenu.js"></script>
<script src="../dist/jquery/menu/jquery.ui.position.js"></script>
<script src="../dist/ag-grid/ag-grid-community.js"></script>
<script src="../dist/plugins/moment-with-locales.min.js"></script>
<script src="../dist/plugins/moment-timezone-with-data-2012-2022.min.js"></script>

<script src="visualization.js"></script>
<script src="networkmap-graph.js"></script>
<script src="networkmap-grid.js"></script>
<script src="networkmap-menumap.js"></script>
<script src="networkmap.js"></script>
<script src="popup-modify-harvest-processor.js"></script>
<script src="popup-modify-harvest.js"></script>
<script src="popup-hop-path.js"></script>
<script src="url-browse.js"></script>

<script>
    var urlParameters=getUrlVars();
    var jobId=parseInt(urlParameters["targetInstanceOid"]);
    var harvestResultId=parseInt(urlParameters["harvestResultId"]);
    var harvestResultNumber=parseInt(urlParameters["harvestNumber"]);

    var visHopPath=new HopPath('hoppath-canvas', jobId, harvestResultNumber);
    var networkmap=new NetworkMap();
    var gPopupModifyHarvest=new PopupModifyHarvest(jobId, harvestResultId, harvestResultNumber);
    
    console.log(parent);
    var gParentHarvestResultViewTab=parent;
    var isToFullScreen=false;

    function toggleScreenSize(){
      console.log(isToFullScreen);
      if(!gParentHarvestResultViewTab || !gParentHarvestResultViewTab.toggleContentWindowSize){
        console.log('gParentHarvestResultViewTab is null');
        return;
      }
      gParentHarvestResultViewTab.toggleContentWindowSize(isToFullScreen);

      if(isToFullScreen){
        $('.btn-full-screen').html('<i class="fas fa-compress"></i>');
      }else{
        $('.btn-full-screen').html('<i class="fas fa-expand"></i>');
      }

      isToFullScreen=!isToFullScreen;
    }

    function useTargetURL(){
      var url=$("#specifyTargetUrlInput").val();
      $('#importFromUrlInput').val(url);
    }

    function openBulkImportSchemaFile(){
      // $("#label-bulk-import-file").trigger('click');
      $("#bulkImportMetadataFile").trigger('click');
    }

    // Initial UI
    var currentMainTab='networkmap';
    function initUI(){
        $('#btn-group-main-tabs label').on('click', function(e){
          currentMainTab=$(this).attr('name');
          $('.main-tab').hide();
          $('#'+currentMainTab).show();

          if(currentMainTab === 'candidate-query'){
            $('.inspect-only-search-item').removeAttr('disabled');
            $('.inspect-only-menu-item').show();
          }else if(currentMainTab === 'tree-url-names'){
            $('.inspect-only-search-item').attr('disabled', 'disabled');
            $('.inspect-only-menu-item').show();
          }else{
            $('.inspect-only-search-item').attr('disabled', 'disabled');
            $('.inspect-only-menu-item').hide();
          }
        });

        $('.btn-side-group-type').on('click', function(e){
          var name=$(this).attr('name');
          if(name==='statuscode'){
            $('#networkmap-side-table-group-by-status-code').show();
            $('#networkmap-side-table-group-by-content-type').hide();            
          }else{
            $('#networkmap-side-table-group-by-status-code').hide();
            $('#networkmap-side-table-group-by-content-type').show();            
          }

          $('.btn-side-group-type').removeClass('text-primary');
          $(this).addClass('text-primary');
          $('#networkmap-side-container').show();
        });


        // Search input filter
        $(".main-header input[type='search']").on('input', function(e){
          var val=$(this).val();
          gPopupModifyHarvest.filter(val);
        });


        $('#btn-bulk-import-submit').on('click', function(e){
          var step=$(this).attr('step');
          if (step==='0') {
            gPopupModifyHarvest.processorModify.bulkImportStep0();            
          }else{
            gPopupModifyHarvest.processorModify.bulkImportStep1();
          }
        });

        // bsCustomFileInput.init();
        // $("#a-link-summary").trigger('click');
    }

    // Initial Data
    function initData(){
      updateDerivedHarvestResults();
      networkmap.init(jobId, harvestResultNumber);
      gPopupModifyHarvest.initTreeWithSeedUrls();
      gPopupModifyHarvest.initTreeWithSearchCommand(null);
    }

    var timerProgress;
    function reindex(){
      var reqUrl="/visualization/index/initial?job=" + jobId + "&harvestResultNumber=" + harvestResultNumber;
      fetchHttp(reqUrl, null, function(response){
        console.log(response.rspCode + ': ' + response.rspMsg);

        if (response.rspCode!==0) {
          return;
        }

        //show progress bar
        g_TurnOnOverlayLoading();
        $('#progressIndexer').show();

        //refresh progress
        timerProgress=setInterval(function(){
          refreshprogress();
        }, 1200);
      });
    }

    //Checking and show progress
    function refreshprogress(){
      var reqUrl="/curator/visualization/progress?job=" + this.jobId + "&harvestResultNumber=" + this.harvestResultNumber;
      fetch(reqUrl, { 
        method: 'GET',
        redirect: 'follow',
        headers: {'Content-Type': 'application/json'},
      }).then((response) => {
        console.log(response);
        return response.json();
      }).then((response) => {
        console.log(response.rspCode + ': ' + response.rspMsg);

        var progressPercentage=0;
        if(response.rspCode===0){
          var responseProgressBar=JSON.parse(response.payload);
          progressPercentage=responseProgressBar.progressPercentage;

          $('#progressIndexerValue').html(progressPercentage);
        }
        
        if((response.rspCode===0 && progressPercentage >= 100) || response.rspCode!=0){
          clearInterval(timerProgress);
          $('#progressIndexer').hide();
          g_TurnOffOverlayLoading();
          initGlobalSettings();
        }
      });
    }

    //Fetch global settings and trigger the loading of data
    function initGlobalSettings(){
      fetchHttp('/get/global-settings?targetInstanceOid='+jobId+'&harvestResultId='+harvestResultId+'&harvestNumber='+harvestResultNumber,{}, function(rsp){
        if (!rsp) {
          alert('Failed to get global settings from server.');
          return;
        }

        var currentVersion=rsp.currentVersion;
        var globalVersion=rsp.globalVersion;
        if (rsp.retrieveResult === "0") {
          _browse_type=rsp.browseType;
          _browse_base_url=rsp.browseBaseUrl;
          initData();
        }else if(rsp.retrieveResult === "9" && confirm("Index file is missing or need to be updated. Would you reindex the harvest result?")) {        //If could not get the BDB version or the BDB does not exit, then prompt with users to confim redex.
          reindex();
        }
      });
    }

    //Main initial function
    $(function(){
        console.log(parent);
        
        toggleScreenSize();

        initUI();

        initGlobalSettings();
    });
</script>
</body>